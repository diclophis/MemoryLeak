<!doctype html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="utf-8">
    <title>MemoryLeak</title>
    <style>
      canvas { background-color: blue; padding-left: 0; padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
    </style>
    <script>
      // Checking for an update. Always the first event fired in the sequence.
      window.applicationCache.addEventListener("checking", function(e) {
        window.clearTimeout(installerTimeout);
        //console.log("checking");
      }, false);

      // Fired after the first cache of the manifest.
      window.applicationCache.addEventListener("cached", function(e) {
        //console.log("cached");
      }, false);

      // An update was found. The browser is fetching resources.
      window.applicationCache.addEventListener('downloading', function(e) {
        //console.log("downloading");
      }, false);

      // The manifest returns 404 or 410, the download failed,
      // or the manifest changed while the download was in progress.
      window.applicationCache.addEventListener('error', function(e) {
        window.clearTimeout(installerTimeout);
        //console.log("error, not sure what to do here");
      }, false);

      // Fired after the first download of the manifest.
      window.applicationCache.addEventListener('noupdate', function(e) {
        window.clearTimeout(installerTimeout);
        //console.log("no update required....");
      }, false);

      // Fired if the manifest file returns a 404 or 410.
      // This results in the application cache being deleted.
      window.applicationCache.addEventListener('obsolete', function(e) {
        //console.log("cache is obsolete");
      }, false);

      // Fired for each resource listed in the manifest as it is being fetched.
      window.applicationCache.addEventListener('progress', function(e) {
        //console.log("progress");
      }, false);

      function onUpdateReady() {  
        //console.log("found new version!, SWAP()");  
        //window.applicationCache.swapCache();
      }

      window.applicationCache.addEventListener("updateready", onUpdateReady);  
      if(window.applicationCache.status === window.applicationCache.UPDATEREADY) {  
        onUpdateReady();  
      }

      document.addEventListener("DOMContentLoaded", function () {
        var startGame = cwrap('start_game', 'number', ['number']);
        var buttons = document.getElementsByTagName("button");
        for (i in buttons) {
          if (buttons[i].className == "game") {
            buttons[i].onclick = function(e) {
              startGame(this.value);
            };
          }
        }
        var manifestFile = new XMLHttpRequest();
        //var manifestUrl = document.getElementsByTagName("html").item(0).getAttribute("manifest");
        var manifestUrl = "index.appcache";
        manifestFile.open("GET", manifestUrl, true);
        manifestFile.onload = function(e) {
          var assets = FS.createFolder("/", "assets", true, false);
          var sounds = FS.createFolder(assets, "sounds", true, false);
          var textures = FS.createFolder(assets, "textures", true, false);
          var levels = FS.createFolder(assets, "levels", true, false);
          var models = FS.createFolder(assets, "models", true, false);
          var lines = this.response.split("\n");
          for (i in lines) {
            (function() {
              var line = lines[i];
              if (line.indexOf("assets") == 0) {
                addRunDependency();
                var lastSlashIndex = line.lastIndexOf("/");
                var dirName = line.substr(0, lastSlashIndex);
                var baseName = line.substr(lastSlashIndex + 1, line.length);
                var dataFile = new XMLHttpRequest();
                dataFile.open("GET", line, true);
                dataFile.responseType = "arraybuffer";
                dataFile.onload = function(e) {
                  var arrayBuffer = this.response;
                  var byteArray = arrayBuffer.byteLength ? new Uint8Array(arrayBuffer) : arrayBuffer;
                  FS.createDataFile(dirName, baseName, byteArray, true, false);
                  removeRunDependency();
                }
                dataFile.send(null);
              }
            })();
          }
          removeRunDependency();
        }
        manifestFile.send(null);
      });
    </script>
  </head>
  <body>
    <script>
      var Module = {
        noInitialRun: true,
        print: (function() {
          return function(text) {
            console.log(text);
            //document.getElementById("wham").innerHTML += text + "<br/>";
          };
        })(),
        canvas: (function() { var canvas = document.createElement("canvas"); document.body.appendChild(canvas); return canvas; })(),
        setStatus: function(text) {
          console.log(text);
          //document.getElementById("wham").innerHTML += text + "<br/>";
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Downloading: ' + (this.totalDependencies-left) + '/' + this.totalDependencies : 'All downloads complete.');
        }
      };
    </script>
    <button class="game" value="0">MainMenu</button>
    <button class="game" value="1">SuperStarShooter</button>
    <button class="game" value="2">RadiantFireEightSixOne</button>
    <button class="game" value="3">SpaceShipDown</button>
    <button class="game" value="4">RadiantDawn</button>
    <script src="sink.js"></script>
    <script src="raptor_island.js"></script>
  </body>
</html>
