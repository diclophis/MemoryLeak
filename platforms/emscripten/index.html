<!doctype html>
<html lang="en-us" manifest="index.appcache">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="utf-8">
    <title>MemoryLeak</title>
    <style>
      canvas { padding-left: 0; padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
    </style>
    <script>

      var isApplicationInstalled = false;

      var installerTimeout = window.setTimeout(function() {
        try {
          window.applicationCache.update();
        } catch (e) {
          console.log("user is activly denying application install, the only option here is to reload()");
          //window.location.reload();
        }
      }, 10000);


      // Checking for an update. Always the first event fired in the sequence.
      window.applicationCache.addEventListener("checking", function(e) {
        window.clearTimeout(installerTimeout);
        console.log("checking");
      }, false);

      // Fired after the first cache of the manifest.
      window.applicationCache.addEventListener("cached", function(e) {
        console.log("cached");
      }, false);


      // An update was found. The browser is fetching resources.
      window.applicationCache.addEventListener('downloading', function(e) {
        console.log("downloading");
      }, false);

      // The manifest returns 404 or 410, the download failed,
      // or the manifest changed while the download was in progress.
      window.applicationCache.addEventListener('error', function(e) {
        console.log("error, not sure what to do here");
      }, false);

      // Fired after the first download of the manifest.
      window.applicationCache.addEventListener('noupdate', function(e) {
        console.log("no update required....");
      }, false);

      // Fired if the manifest file returns a 404 or 410.
      // This results in the application cache being deleted.
      window.applicationCache.addEventListener('obsolete', function(e) {
        console.log("cache is obsolete");
      }, false);

      // Fired for each resource listed in the manifest as it is being fetched.
      window.applicationCache.addEventListener('progress', function(e) {
        console.log("progress");
      }, false);

      function onUpdateReady() {  
        console.log("found new version!, SWAP()");  
        window.applicationCache.swapCache();
      }

      window.applicationCache.addEventListener("updateready", onUpdateReady);  
      if(window.applicationCache.status === window.applicationCache.UPDATEREADY) {  
        onUpdateReady();  
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("js is done??");

        var dataFile = new XMLHttpRequest();
        dataFile.open('GET', document.getElementsByTagName("html").item(0).getAttribute("manifest"), true);
        dataFile.responseType = 'arraybuffer';
        dataFile.onload = function() {
          console.log("got manifest");
        }
        dataFile.send(null);
      });
    </script>
  </head>
  <body>
    <h1>foo</h1>
    <script>
      var Module = {
        noInitialRun: true,
        print: (function() {
          return function(text) {
            console.log(text);
          };
        })(),
        canvas: document.createElement("canvas"),
        setStatus: function(text) {
          console.log(text);
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Downloading: ' + (this.totalDependencies-left) + '/' + this.totalDependencies : 'All downloads complete.');
        },
        preRun: function() {
          // this is odd, and is actually fixed in incoming branch of emscripten
          window.SDL = {
            structs: {
              AudioSpec: Runtime.generateStructInfo([
                ['i32', 'freq'],
                ['i16', 'format'],
                ['i8', 'channels'],
                ['i8', 'silence'],
                ['i16', 'samples'],
                ['i32', 'size'],
                ['void*', 'callback'],
                ['void*', 'userdata']
              ])
            }
          };
        }
      };
    </script>
    <script src="raptor_island.js"></script>
  </body>
</html>
